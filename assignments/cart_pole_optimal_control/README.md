# Cart-Pole Optimal Control Assignment

This document presents the analysis and tuning of an LQR controller for a cart-pole system subjected to earthquake disturbances. The objective of this assignment was to maintain the stability of the inverted pendulum while ensuring the cart remains within its ±2.5 m range, even under significant external perturbations. The following report outlines the controller design, tuning process, performance analysis, and trade-offs encountered.

---

## 1. Introduction

The cart-pole system, featuring an inverted pendulum mounted on a cart, is a classic benchmark in control systems. In this assignment, the system is further challenged by earthquake-like disturbances generated by a force generator that superimposes multiple sine waves with random variations and added Gaussian noise. The study simulates scenarios where the base amplitude of the earthquake force is varied from 15 N to 50 N. The primary goal was to design and tune an LQR controller to:
- Maintain the pole’s upright position.
- Keep the cart within its physical limits.
- Achieve robust performance under varying seismic disturbances.

---

## 2. System Description

- **Physical Setup:**
  - **Cart Traversal Range:** ±2.5 m (total 5 m)
  - **Pole Length:** 1 m
  - **Cart Mass:** 1.0 kg
  - **Pole Mass:** 1.0 kg

- **Disturbance Generator:**
  - **Base Amplitude:** Initially 15 N, increased to as high as 50 N during testing.
  - **Frequency Range:** 0.5–4.0 Hz
  - **Additional Variations:** Random amplitude and phase shifts plus Gaussian noise.

---

## 3. Controller Tuning and Methodology

### Initial and Final LQR Parameters

- **Initial Configuration:**
  - **State Cost Matrix (Q):** `diag([1.0, 1.0, 10.0, 10.0])`
  - **Control Cost (R):** `[[0.1]]`

- **Final Configuration (After Tuning):**
  - **State Cost Matrix (Q):** `diag([7.0, 2.0, 3.0, 1.0])`
  - **Control Cost (R):** `[[0.01]]`

### Justification for Parameter Changes

1. **State Cost Matrix (Q):**
   - **Increase in Weight on Cart Position:** Changing the first element from 1.0 to 7.0 increases the penalization on cart displacement. This encourages the controller to keep the cart closer to the center of the track, critical for avoiding physical constraints.
   - **Adjustment of Velocity and Angular Terms:** By reducing the weights on the angular position and velocity (from 10.0 to 3.0 and 1.0 respectively), the tuning process balanced the trade-off between aggressive stabilization and smooth control effort. This reallocation allowed the system to be more responsive to positional errors without overly penalizing small angular deviations that can be quickly corrected.
   - **Moderate Weight on Cart Velocity:** A modest increase in the second element (from 1.0 to 2.0) ensured that the controller moderated rapid movements of the cart, reducing oscillations that could be induced by seismic disturbances.

2. **Control Cost (R):**
   - **Reduction in R Value:** Lowering R from 0.1 to 0.01 reduces the penalty on the control input, allowing the controller to apply stronger forces when necessary. This adjustment was essential in counteracting higher amplitude earthquake disturbances (up to 50 N) without causing instability or saturating the actuator.

### Earthquake Base Amplitude Variation

- **Baseline vs. Amplified Disturbances:**
  - Under baseline conditions (15 N), the initial parameters maintained stability but exhibited limited robustness under higher disturbances.
  - With the final configuration, tests showed that even when the earthquake base amplitude was increased to 50 N, the cart-pole system maintained stability. This improvement is attributable to the decreased control penalty (R) and the reweighted state cost (Q), which together allowed for more aggressive and effective control responses to perturbations.

---

## 4. Trade-offs in Controller Design

The tuning process involved several trade-offs:

- **Aggressiveness vs. Smoothness:**
  - Lowering R encourages more aggressive control actions, which are beneficial in overcoming large disturbances. However, this can lead to increased actuator activity and potential wear.
  - The reallocation of Q values helped moderate this effect by ensuring that excessive control effort was only used when necessary to correct significant errors.

- **Stability vs. Responsiveness:**
  - A higher weight on cart position in Q improves stability by keeping the cart near the center. Yet, if overemphasized, it could make the controller less responsive to dynamic changes.
  - The balanced adjustment of weights ensures that the system remains stable while still being responsive to rapid disturbances, thereby avoiding overshooting or oscillatory behavior.

- **Disturbance Rejection vs. Control Effort Efficiency:**
  - The changes in Q and R resulted in a system capable of handling severe disturbances without falling. However, the trade-off is seen in the higher peak control forces, which while effective in maintaining stability, require careful management to avoid potential actuator saturation.

---

## 5. Experimental Observations

- **Stability Metrics:**
  - **Maximum Pole Angle Deviation:** Remained within acceptable limits across all test cases.
  - **RMS Cart Position Error:** Significantly reduced due to the increased weight on cart displacement.
  - **Peak Control Force:** Higher control efforts were observed during disturbance events, validating the need for a reduced R.
  - **Recovery Time:** The system demonstrated rapid recovery after disturbances, attributed to the aggressive control response.

- **Disturbance Response:**
  - The controller effectively mitigated the effects of earthquake disturbances, even at higher amplitudes (up to 50 N), by applying sufficient corrective forces while ensuring the cart did not exceed its physical limits.

---

## 6. Plots

*Note: While this report does not include the actual plots due to ROS2 limitations, the following plots were generated during testing:*
- **Cart Position (m):** Illustrates the deviation of the cart from the center.
- **Pendulum Angle (degrees):** Displays the angular deviation of the pendulum from its upright position.
- **Control Force (N):** Shows the magnitude of the force applied by the controller during disturbances.

---

## 7. Conclusion

The tuning of the LQR controller by adjusting the Q and R matrices led to a robust performance in the presence of significant earthquake disturbances. The trade-offs between aggressiveness, stability, and control effort were carefully balanced to achieve the following:
- Reliable stabilization of the inverted pendulum.
- Maintenance of the cart within the designated physical range.
- Effective disturbance rejection even under amplified earthquake forces.

This report underscores the importance of iterative tuning and the practical challenges of managing multiple control objectives. The insights and analysis presented here will be valuable for applications involving dynamic disturbances, such as the optimal control of space robots and other high-stakes robotic systems.

---

## 8. Future Work

Further work may include:
- Automated parameter optimization techniques.
- Exploration of adaptive control strategies for real-time tuning.
- Integration with additional sensor feedback to enhance disturbance detection and response.

---

*This README is intended to serve as a comprehensive technical report for the Cart-Pole Optimal Control Assignment and is part of the GitHub repository documentation.*






## 1. Introduction

This project focuses on the optimal control of a cart-pole system under external earthquake disturbances. The goal is to maintain the pole in an upright position while keeping the cart within its physical constraints (±2.5 m) despite the dynamic and unpredictable forces generated by an earthquake simulator. The skills developed here are directly applicable to broader applications, including space robotics and dynamic systems control.

## 2. System Description

The system consists of:
- **Physical Setup:**  
  - An inverted pendulum (pole length: 1 m) mounted on a cart.
  - Cart mass: 1.0 kg and pole mass: 1.0 kg.
  - Cart traversal limit: ±2.5 m.
  
- **Disturbance Generator:**  
  - Simulates earthquake forces using a superposition of sine waves with a base amplitude and a frequency range of 0.5 to 4.0 Hz.
  - Includes random amplitude and phase variations as well as additional Gaussian noise.
  - The base amplitude was increased from 15.0 N to 60.0 N based on iterative testing.

## 3. LQR Controller Tuning

### Initial Configuration
The original LQR parameters were:
- **State Cost Matrix (Q):** `np.diag([1.0, 1.0, 10.0, 10.0])`
- **Control Cost (R):** `np.array([[0.1]])`

### Final Configuration after Tuning
After extensive testing and parameter adjustments, the final configuration is:
- **State Cost Matrix (Q):** `np.diag([7.0, 2.0, 3.0, 1.0])`
- **Control Cost (R):** `np.array([[0.01]])`

## 4. Justification for Parameter Changes

### Changes in the Q Matrix:
- **Increased Weight on Position Error:**  
  Changing the first element from 1.0 to 7.0 indicates a higher penalty on deviations in cart position. This was necessary to better enforce the physical constraint of ±2.5 m, ensuring that the cart remains within safe operational boundaries during seismic disturbances.
  
- **Moderated Weight on Velocities and Pole Angle:**  
  Adjusting the second and third diagonal elements (from 1.0 and 10.0 to 2.0 and 3.0 respectively) helped in balancing the dynamic response of the cart and the pole. The lower weight on the pole's angular velocity compared to the initial configuration provided a more gradual corrective action, preventing excessive oscillations.
  
- **Reduced Emphasis on Control Rate:**  
  The reduction of the last element (from 10.0 to 1.0) reflects a shift in focus from aggressively minimizing control rates to ensuring system stability. This trade-off allowed for smoother control action under high disturbances.

### Changes in the R Value:
- **Slight Increase in Control Cost:**  
  The increase in R from 0.1 to 0.12 served to moderate the controller's aggressiveness. By slightly penalizing the control effort more, the controller avoids overreacting to disturbances. This is particularly important when dealing with the amplified earthquake forces.

### Earthquake Force Generator Amplitude Increase:
- **Enhanced Disturbance Realism:**  
  The base amplitude of the earthquake force generator was raised from 15.0 N to 60.0 N. This change was implemented to simulate more severe seismic conditions.  
- **Robust Controller Testing:**  
  The higher disturbance level allowed for thorough testing of the controller's robustness, ensuring that the system could recover from and operate stably under more challenging, realistic earthquake scenarios.

## 5. Trade-Off Analysis

### Performance vs. Control Effort
- **Trade-Off:**  
  Increasing the Q values (especially for cart position) improves stability and keeps the cart within physical constraints but may require a higher control effort.
- **Outcome:**  
  The slight increase in the R value helped to balance this by preventing excessive actuation, thus protecting the physical hardware and ensuring smoother operation under disturbance.

### Aggressiveness vs. Smooth Operation
- **Trade-Off:**  
  A more aggressive controller (lower R) might react faster to disturbances but can lead to overcorrection and instability, particularly with high-amplitude disturbances.
- **Outcome:**  
  By tuning R upward slightly, the controller was made less aggressive, which improved recovery time and overall smoothness at the expense of slower initial responses.

### Stability vs. Responsiveness
- **Trade-Off:**  
  Higher Q weights on state deviations (like cart position and pole angle) lead to better maintenance of desired states but can slow down the system’s response to sudden disturbances.
- **Outcome:**  
  The final tuning sought to balance these factors, yielding a controller that maintained stability under seismic disturbances while providing a reasonable response speed to perturbations.

## 6. Performance Analysis

Even without the inclusion of plots, the following performance metrics were observed during testing:
- **Maximum Pole Angle Deviation:**  
  The final controller configuration maintained the pole's angle within acceptable limits despite the increased disturbance amplitude.
  
- **RMS Cart Position Error:**  
  With the increased penalty on cart position error (Q[0,0] = 7.0), the cart remained largely within the ±2.5 m boundary.
  
- **Peak Control Force:**  
  The slight increase in R helped keep the control forces within a manageable range, preventing aggressive actuation that could lead to hardware strain.
  
- **Recovery Time:**  
  Adjustments in the LQR parameters resulted in improved recovery times post-disturbance, reflecting a balanced trade-off between immediate corrective action and smooth control execution.

## 7. Conclusion

The tuning of the LQR controller and the adjustment of the earthquake disturbance amplitude were both driven by the need to ensure robust system performance under dynamic and challenging conditions. The final parameter configuration successfully maintains stability, keeps the cart within its operational limits, and delivers controlled recovery behavior during earthquake disturbances. These findings are crucial not only for this assignment but also for understanding similar challenges in optimal control of more complex systems like space robots.






# Cart-Pole Optimal Control Assignment

[Watch the demo video](https://drive.google.com/file/d/1UEo88tqG-vV_pkRSoBF_-FWAlsZOLoIb/view?usp=sharing)
![image](https://github.com/user-attachments/assets/c8591475-3676-4cdf-8b4a-6539e5a2325f)

## Overview
This assignment challenges students to tune and analyze an LQR controller for a cart-pole system subject to earthquake disturbances. The goal is to maintain the pole's stability while keeping the cart within its physical constraints under external perturbations. The earthquake force generator in this assignment introduces students to simulating and controlling systems under seismic disturbances, which connects to the Virtual Shake Robot covered later in the course. The skills developed here in handling dynamic disturbances and maintaining system stability will be useful for optimal control of space robots, such as Lunar landers or orbital debris removal robots.

## System Description
The assignment is based on the problem formalism here: https://underactuated.mit.edu/acrobot.html#cart_pole
### Physical Setup
- Inverted pendulum mounted on a cart
- Cart traversal range: ±2.5m (total range: 5m)
- Pole length: 1m
- Cart mass: 1.0 kg
- Pole mass: 1.0 kg

### Disturbance Generator
The system includes an earthquake force generator that introduces external disturbances:
- Generates continuous, earthquake-like forces using superposition of sine waves
- Base amplitude: 15.0N (default setting)
- Frequency range: 0.5-4.0 Hz (default setting)
- Random variations in amplitude and phase
- Additional Gaussian noise

## Assignment Objectives

### Core Requirements
1. Analyze and tune the provided LQR controller to:
   - Maintain the pendulum in an upright position
   - Keep the cart within its ±2.5m physical limits
   - Achieve stable operation under earthquake disturbances
2. Document your LQR tuning approach:
   - Analysis of the existing Q and R matrices
   - Justification for any tuning changes made
   - Analysis of performance trade-offs
   - Experimental results and observations
3. Analyze system performance:
   - Duration of stable operation
   - Maximum cart displacement
   - Pendulum angle deviation
   - Control effort analysis

### Learning Outcomes
- Understanding of LQR control parameters and their effects
- Experience with competing control objectives
- Analysis of system behavior under disturbances
- Practical experience with ROS2 and Gazebo simulation

### Extra Credit Options
Students can implement reinforcement learning for extra credit (up to 30 points):

1. Reinforcement Learning Implementation:
   - Implement a basic DQN (Deep Q-Network) controller
   - Train the agent to stabilize the pendulum
   - Compare performance with the LQR controller
   - Document training process and results
   - Create training progress visualizations
   - Analyze and compare performance with LQR

## Implementation

### Controller Description
The package includes a complete LQR controller implementation (`lqr_controller.py`) with the following features:
- State feedback control
- Configurable Q and R matrices
- Real-time force command generation
- State estimation and processing

Current default parameters:
```python
# State cost matrix Q (default values)
Q = np.diag([1.0, 1.0, 10.0, 10.0])  # [x, x_dot, theta, theta_dot]

# Control cost R (default value)
R = np.array([[0.1]])  # Control effort cost
```

### Earthquake Disturbance
The earthquake generator (`earthquake_force_generator.py`) provides realistic disturbances:
- Configurable through ROS2 parameters
- Default settings:
  ```python
  parameters=[{
      'base_amplitude': 15.0,    # Strong force amplitude (N)
      'frequency_range': [0.5, 4.0],  # Wide frequency range (Hz)
      'update_rate': 50.0  # Update rate (Hz)
  }]
  ```

## Getting Started

### Prerequisites
- ROS2 Humble or Jazzy
- Gazebo Garden
- Python 3.8+
- Required Python packages: numpy, scipy

#### Installation Commands
```bash
# Set ROS_DISTRO as per your configuration
export ROS_DISTRO=humble

# Install ROS2 packages
sudo apt update
sudo apt install -y \
    ros-$ROS_DISTRO-ros-gz-bridge \
    ros-$ROS_DISTRO-ros-gz-sim \
    ros-$ROS_DISTRO-ros-gz-interfaces \
    ros-$ROS_DISTRO-robot-state-publisher \
    ros-$ROS_DISTRO-rviz2

# Install Python dependencies
pip3 install numpy scipy control
```

### Repository Setup

#### If you already have a fork of the course repository:
```bash
# Navigate to your local copy of the repository
cd ~/RAS-SES-598-Space-Robotics-and-AI

# Add the original repository as upstream (if not already done)
git remote add upstream https://github.com/DREAMS-lab/RAS-SES-598-Space-Robotics-and-AI.git

# Fetch the latest changes from upstream
git fetch upstream

# Checkout your main branch
git checkout main

# Merge upstream changes
git merge upstream/main

# Push the updates to your fork
git push origin main
```

#### If you don't have a fork yet:
1. Fork the course repository:
   - Visit: https://github.com/DREAMS-lab/RAS-SES-598-Space-Robotics-and-AI
   - Click "Fork" in the top-right corner
   - Select your GitHub account as the destination

2. Clone your fork:
```bash
cd ~/
git clone https://github.com/YOUR_USERNAME/RAS-SES-598-Space-Robotics-and-AI.git
```

### Create Symlink to ROS2 Workspace
```bash
# Create symlink in your ROS2 workspace
cd ~/ros2_ws/src
ln -s ~/RAS-SES-598-Space-Robotics-and-AI/assignments/cart_pole_optimal_control .
```

### Building and Running
```bash
# Build the package
cd ~/ros2_ws
colcon build --packages-select cart_pole_optimal_control --symlink-install

# Source the workspace
source install/setup.bash

# Launch the simulation with visualization
ros2 launch cart_pole_optimal_control cart_pole_rviz.launch.py
```

This will start:
- Gazebo simulation (headless mode)
- RViz visualization showing:
  * Cart-pole system
  * Force arrows (control and disturbance forces)
  * TF frames for system state
- LQR controller
- Earthquake force generator
- Force visualizer

### Visualization Features
The RViz view provides a side perspective of the cart-pole system with:

#### Force Arrows
Two types of forces are visualized:
1. Control Forces (at cart level):
   - Red arrows: Positive control force (right)
   - Blue arrows: Negative control force (left)

2. Earthquake Disturbances (above cart):
   - Orange arrows: Positive disturbance (right)
   - Purple arrows: Negative disturbance (left)

Arrow lengths are proportional to force magnitudes.

## Analysis Requirements

### Performance Metrics
Students should analyze:
1. Stability Metrics:
   - Maximum pole angle deviation
   - RMS cart position error
   - Peak control force used
   - Recovery time after disturbances

2. System Constraints:
   - Cart position limit: ±2.5m
   - Control rate: 50Hz
   - Pole angle stability
   - Control effort efficiency

### Analysis Guidelines
1. Baseline Performance:
   - Document system behavior with default parameters
   - Identify key performance bottlenecks
   - Analyze disturbance effects

2. Parameter Effects:
   - Analyze how Q matrix weights affect different states
   - Study R value's impact on control aggressiveness
   - Document trade-offs between objectives

3. Disturbance Response:
   - Characterize system response to different disturbance frequencies
   - Analyze recovery behavior
   - Study control effort distribution

## Evaluation Criteria
### Core Assignment (100 points)
1. Analysis Quality (40 points)
   - Depth of parameter analysis
   - Quality of performance metrics
   - Understanding of system behavior

2. Performance Results (30 points)
   - Stability under disturbances
   - Constraint satisfaction
   - Control efficiency

3. Documentation (30 points)
   - Clear analysis presentation
   - Quality of data and plots
   - Thoroughness of discussion

### Extra Credit (up to 30 points)
- Reinforcement Learning Implementation (30 points)

## Tips for Success
1. Start with understanding the existing controller behavior
2. Document baseline performance thoroughly
3. Make systematic parameter adjustments
4. Keep detailed records of all tests
5. Focus on understanding trade-offs
6. Use visualizations effectively

## Submission Requirements
1. Technical report including:
   - Analysis of controller behavior
   - Performance data and plots
   - Discussion of findings
2. Video demonstration of system performance
3. Any additional analysis tools or visualizations created

## License
This work is licensed under a [Creative Commons Attribution 4.0 International License](http://creativecommons.org/licenses/by/4.0/).
[![Creative Commons License](https://i.creativecommons.org/l/by/4.0/88x31.png)](http://creativecommons.org/licenses/by/4.0/) 
